# Kubernetes

```bash 
# Create the secret for the certificates
kubectl create secret generic traefik-cert --namespace traefik-v2 --from-file=ca.crt=./ca.crt --dry-run=client -o yaml > 005-myapp-secret.yaml
kubectl apply -f 005-myapp-secret.yaml

# Create the secret for traefik-dashboard
kubectl create secret tls traefik-dashboard-cert --cert=tls.crt --key=tls.key -n traefik-v2 --dry-run=client -o yaml | kubectl apply -f -

# Create the PVC for the certificates
kubectl create -f 007-myapp-new-pv-pvc.yaml

# Create the traefik-dashboard ingress-route
kubectl create -f 001-traefik-dashboard.yaml

#Deploy myapp
kubectl create -f 003-myapp-foo-bar.yaml

# Deploy the ingress-route metrics for myapp (Enable Prometheus first - See `prometheus` directory)
kubectl create -f 006-myapp-metrics.yaml
```
* Create basic auth for the myapp. See `users` directory.

# Kubernetes Version Sync Script

> Add a script `update-version.sh` to control the version of the deployment and the image updater file.

## When to Use

1. **After Pipeline Runs**
   - When new images are built and deployed
   - After Argo CD Image Updater makes changes

2. **Local Development**
   - After pulling new changes
   - Before creating PRs
   - When versions are out of sync

3. **Troubleshooting**
   - When investigating version mismatches
   - After manual cluster changes
   - When Argo CD sync issues occur

## Prerequisites

- `kubectl` configured with cluster access
- `sed` command (comes with most Unix-like systems)
- Proper permissions to read/write YAML files

## Files Involved

1. **Deployment Manifest**
   - Contains the Kubernetes deployment configuration
   - Example: `003-myapp-foo-bar.yaml`

2. **Argo CD Image Updater File**
   - Generated by Argo CD Image Updater
   - Format: `.argocd-source-*.yaml`
   - Contains the latest image version information

## Best Practices

1. **Version Control**
   - Commit both deployment and Argo CD Image Updater files
   - Track version changes through git history
   - Review changes before pushing

2. **Usage Timing**
   - Run after pulling new changes
   - Run before committing changes
   - Run when versions seem out of sync

3. **Monitoring**
   - Check script output for warnings
   - Verify cluster state after updates
   - Keep track of version changes

## Troubleshooting

If you encounter issues:

1. **File Not Found**
   - Ensure you're in the correct directory
   - Check file permissions
   - Verify file names match expected patterns

2. **Version Mismatch**
   - Verify cluster connection
   - Check Argo CD Image Updater status
   - Confirm image exists in registry

3. **Update Failures**
   - Check write permissions
   - Verify YAML file format
   - Ensure proper cluster access

